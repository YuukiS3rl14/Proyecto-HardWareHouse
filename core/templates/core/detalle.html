{% extends 'core/base.html' %}
{% load static %}
{% load humanize %}

{% block tittle %}{{ producto.nombre }} - Detalle{% endblock %}

{% block principal %}
<!-- Contenido principal -->
<div class="container py-5">
    <div class="row">
        <!-- Columna de Imagen -->
        <div class="col-lg-5 mb-4">
            {% if producto.imagen %}
                <img src="{{ producto.imagen.url }}" class="img-fluid border rounded" alt="{{ producto.nombre }}">
            {% else %}
                <img src="{% static 'core/img/placeholder_detail.webp' %}" class="img-fluid border rounded" alt="Producto Sin Imagen">
            {% endif %}
        </div>
        
        <!-- Columna de Información -->
        <div class="col-lg-7">
            <h3 class="font-weight-bold">{{ producto.nombre }}</h3>
            <p class="text-muted">Marca: {{ producto.proveedor.nombre }} | Categoría: {{ producto.categoria }}</p>
            
            <div class="d-flex mb-3">
                <div class="text-success mr-2" title="{{ promedio_calificacion|floatformat:1 }} de 5 estrellas">
                    {% with promedio_entero=promedio_calificacion|floatformat:"0" %}
                        {% for i in "12345" %}
                            {% if i <= promedio_entero %}
                                <small class="fas fa-star"></small>
                            {% else %}
                                <small class="far fa-star"></small>
                            {% endif %}
                        {% endfor %}
                    {% endwith %}
                </div>
                <small class="pt-1">({{ total_comentarios }} reseña{{ total_comentarios|pluralize:"s" }})</small> 
            </div>
            
            <!-- Precio Formateado -->
            <h3 class="text-success font-weight-bold mb-4">${{ producto.precio|floatformat:"0"|intcomma }} CLP</h3>
            
            <!-- Descripción -->
            <p>{{ producto.descripcion|default:"Descripción no disponible." }}</p>
            
            <!-- Especificaciones Adicionales (Ejemplo de acceso) -->
            <hr>
            <h5>Especificaciones Clave</h5>
            <ul class="list-unstyled">
                {# Atributos de Procesador #}
                {% if producto.socket %} <li><strong>Socket:</strong> {{ producto.socket }}</li> {% endif %}
                {% if producto.nucleos %} <li><strong>Núcleos:</strong> {{ producto.nucleos }}</li> {% endif %}
                {% if producto.frecuencia_base %} <li><strong>Frecuencia Base:</strong> {{ producto.frecuencia_base }} GHz</li> {% endif %}

                {# Atributos de Tarjeta Gráfica #}
                {% if producto.vram_gb %} <li><strong>VRAM:</strong> {{ producto.vram_gb }} GB</li> {% endif %}
                {% if producto.tipo_memoria %} <li><strong>Tipo de Memoria:</strong> {{ producto.tipo_memoria }}</li> {% endif %}
                {% if producto.interfaz %} <li><strong>Interfaz:</strong> {{ producto.interfaz }}</li> {% endif %}

                {# Atributos de Memoria RAM #}
                {% if producto.capacidad_gb and producto.tipo_ddr and producto.velocidad_mhz %}
                    <li><strong>Capacidad:</strong> {{ producto.capacidad_gb }} GB</li>
                    <li><strong>Tipo DDR:</strong> {{ producto.tipo_ddr }}</li>
                    <li><strong>Velocidad:</strong> {{ producto.velocidad_mhz }} MHz</li>
                {% elif producto.capacidad_gb %} {# Para SSD/HDD que también tienen capacidad_gb #}
                    <li><strong>Capacidad:</strong> {{ producto.capacidad_gb }} GB</li>
                {% endif %}

                {# Atributos de Placa Madre #}
                {% if producto.socket_cpu %} <li><strong>Socket CPU:</strong> {{ producto.socket_cpu }}</li> {% endif %}
                {% if producto.chipset %} <li><strong>Chipset:</strong> {{ producto.chipset }}</li> {% endif %}
                {% if producto.formato %} <li><strong>Formato:</strong> {{ producto.formato }}</li> {% endif %}
                {% if producto.ranuras_ram %} <li><strong>Ranuras RAM:</strong> {{ producto.ranuras_ram }}</li> {% endif %}

                {# Atributos de Almacenamiento (SSD/HDD) #}
                {% if producto.interfaz and producto.formato and producto.categoria != 'Memoria RAM' %} {# Evitar duplicar interfaz/formato si ya se mostró para GPU/MB #}
                    <li><strong>Interfaz:</strong> {{ producto.interfaz }}</li>
                    <li><strong>Formato:</strong> {{ producto.formato }}</li>
                {% endif %}
                {% if producto.velocidad_rpm %} <li><strong>Velocidad:</strong> {{ producto.velocidad_rpm }} RPM</li> {% endif %}
                {% if producto.cache_mb %} <li><strong>Caché:</strong> {{ producto.cache_mb }} MB</li> {% endif %}

                {# Atributos de Gabinete #}
                {% if producto.formato_soporte %} <li><strong>Soporte Placa:</strong> {{ producto.formato_soporte }}</li> {% endif %}
                {% if producto.ventiladores_incluidos is not None %} <li><strong>Ventiladores Incluidos:</strong> {% if producto.ventiladores_incluidos %}Sí{% else %}No{% endif %}</li> {% endif %}
                {% if producto.material %} <li><strong>Material:</strong> {{ producto.material }}</li> {% endif %}

                {# Atributos de Fuente de Poder #}
                {% if producto.potencia_watts %} <li><strong>Potencia:</strong> {{ producto.potencia_watts }} W</li> {% endif %}
                {% if producto.certificacion %} <li><strong>Certificación:</strong> {{ producto.certificacion }}</li> {% endif %}
                {% if producto.modular is not None %} <li><strong>Modular:</strong> {% if producto.modular %}Sí{% else %}No{% endif %}</li> {% endif %}

                {# Atributos de Refrigeración y Ventilador #}
                {% if producto.tipo %} <li><strong>Tipo:</strong> {{ producto.tipo }}</li> {% endif %}
                {% if producto.socket_compatibles %} <li><strong>Sockets Compatibles:</strong> {{ producto.socket_compatibles }}</li> {% endif %}
                {% if producto.tamanho_radiador_mm %} <li><strong>Tamaño Radiador:</strong> {{ producto.tamanho_radiador_mm }} mm</li> {% endif %}
                {% if producto.tamanho_mm %} <li><strong>Tamaño:</strong> {{ producto.tamanho_mm }} mm</li> {% endif %}
                {% if producto.rgb is not None %} <li><strong>RGB:</strong> {% if producto.rgb %}Sí{% else %}No{% endif %}</li> {% endif %}

                {# Stock siempre al final #}
                <li><strong>Stock:</strong> 
                    <strong class="{% if producto.stock > 0 %}text-success{% else %}text-danger{% endif %}">
                        {% if producto.stock > 0 %}En stock ({{ producto.stock }} unidades){% else %}Agotado{% endif %}
                    </strong>
                </li>
            </ul>
            <!-- Controles de Compra y Navegación -->
            <div class="d-flex align-items-center mb-4 mt-4">
                <form action="{% url 'agregar_al_carrito' %}" method="POST" class="add-to-cart-form d-flex align-items-center">
                    {% csrf_token %}
                    <input type="hidden" name="product_id" value="{{ producto.id }}">
                    <input type="hidden" name="model_name" value="{{ model_name }}">
    
                    <div class="input-group quantity mr-3" style="width: 130px;">
                        <div class="input-group-btn">
                            <button type="button" class="btn btn-success btn-minus"><i class="fa fa-minus"></i></button>
                        </div>
                        <input type="text" name="quantity" class="form-control bg-light text-center" value="1">
                        <div class="input-group-btn">
                            <button type="button" class="btn btn-success btn-plus"><i class="fa fa-plus"></i></button>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-success px-3">
                        <i class="fa fa-shopping-cart mr-1"></i>Agregar al carrito
                    </button>
                </form>
                <!-- Botón de Favoritos -->
                <button class="btn btn-outline-danger px-3 ml-3 toggle-favorite-btn"
                        data-product-id="{{ producto.id }}"
                        data-model-name="{{ model_name }}"
                        data-url="{% url 'toggle_favorito' %}"
                        data-is-authenticated="{{ user.is_authenticated|yesno:'true,false' }}"
                        data-login-url="{% url 'login' %}"
                        title="{% if is_favorito %}Quitar de favoritos{% else %}Agregar a favoritos{% endif %}">
                    <i class="{% if is_favorito %}fas{% else %}far{% endif %} fa-heart mr-1"></i>
                </button>
            </div>

            <p><strong>Garantía:</strong> 1 año por fabricante</p>
        </div>
    </div>
</div>

<!-- Pestañas de Reseñas y Descripción -->
<div class="container mt-5">
    <div class="row">
        <div class="col">
            <div class="bg-light p-4 rounded">
                <h4 class="mb-4">Reseñas de Usuarios ({{ total_comentarios }})</h4>
                <hr>

                {% for comentario in comentarios %}
                <div class="media mb-4">
                    <img src="{% static 'core/img/default_perfil.webp' %}" alt="Usuario" class="img-fluid mr-3 mt-1" style="width: 45px;">
                    <div class="media-body">
                        <h6>{{ comentario.usuario.username }}<small> - <i>{{ comentario.fecha_creacion|date:"d M, Y" }}</i></small></h6>
                        <div class="text-success mb-2">
                            {% for i in "12345" %}
                                {% if i <= comentario.calificacion|stringformat:"s" %}
                                    <i class="fas fa-star"></i>
                                {% else %}
                                    <i class="far fa-star"></i>
                                {% endif %}
                            {% endfor %}
                        </div>
                        <h5 class="font-weight-bold">{{ comentario.titulo }}</h5>
                        <p>{{ comentario.texto }}</p>
                    </div>
                </div>
                {% empty %}
                <p class="text-muted">Este producto aún no tiene reseñas. ¡Sé el primero en opinar!</p>
                {% endfor %}

                <hr>

                <!-- Formulario para dejar una reseña -->
                <div class="mt-4">
                    <h4 class="mb-4">Deja tu reseña</h4>
                    {% if user.is_authenticated %}
                    <form action="{% url 'agregar_comentario' model_name=model_name pk=producto.id %}" method="POST">
                        {% csrf_token %}
                        <div class="form-group">
                            <label for="{{ comentario_form.calificacion.id_for_label }}">{{ comentario_form.calificacion.label }}</label>
                            {{ comentario_form.calificacion }}
                        </div>
                        <div class="form-group">
                            <label for="{{ comentario_form.titulo.id_for_label }}">{{ comentario_form.titulo.label }}</label>
                            {{ comentario_form.titulo }}
                        </div>
                        <div class="form-group">
                            <label for="{{ comentario_form.texto.id_for_label }}">{{ comentario_form.texto.label }}</label>
                            {{ comentario_form.texto }}
                        </div>
                        <button type="submit" class="btn btn-success px-3">Publicar Reseña</button>
                    </form>
                    {% else %}
                    <div class="alert alert-warning" role="alert">
                        Debes <a href="{% url 'login' %}?next={{ request.path }}" class="alert-link">iniciar sesión</a> para poder dejar una reseña.
                    </div>
                    {% endif %}
                </div>

            </div>
        </div>
    </div>
</div>


<script src="{% static 'core/js/ajax-cart.js' %}"></script>
<script src="{% static 'core/js/ajax-favorites.js' %}"></script>

{% endblock %}
